<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transports ‚Äì Hippodrome de Vincennes</title>
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 10px;
    }
    .section {
      margin-top: 30px;
      padding-top: 10px;
      border-top: 1px solid #444;
    }
    .line { margin: 5px 0; }
    .timestamp {
      font-size: 0.8rem;
      color: #aaa;
      margin-top: 30px;
    }
    .error { color: #f55; }
  </style>
</head>
<body>
  <h1>‚è± Transports autour de l‚ÄôHippodrome de Vincennes</h1>

  <div class="section" id="rer">
    <h2>üöÜ RER A ‚Äì Joinville-le-Pont</h2>
    <div id="rer-data" class="line">Chargement‚Ä¶</div>
  </div>

  <div class="section" id="bus77">
    <h2>üöå Bus 77 ‚Äì Hippodrome de Vincennes</h2>
    <div id="bus77-data" class="line">Chargement‚Ä¶</div>
  </div>

  <div class="section" id="bus201">
    <h2>üöå Bus 201 ‚Äì √âcole du Breuil</h2>
    <div id="bus201-data" class="line">Chargement‚Ä¶</div>
  </div>

  <div class="section" id="velib">
    <h2>üö≤ V√©lib‚Äô</h2>
    <div id="velib-data" class="line">Chargement‚Ä¶</div>
  </div>

  <div class="timestamp" id="last-update">‚Äî</div>

  <script>
    const WORKER_URL = "https://ratp-proxy.hippodrome-proxy42.workers.dev";
    const stops = {
      rer: "STIF:StopPoint:Q:43851:",
      bus77: "STIF:StopPoint:Q:463641:",
      bus201: "STIF:StopPoint:Q:463644:"
    };
    const velibStations = [12128, 12163];

    async function fetchPrim(ref) {
      try {
        const res = await fetch(`${WORKER_URL}?ref=${encodeURIComponent(ref)}`);
        const data = await res.json();
        return data?.Siri?.ServiceDelivery?.StopMonitoringDelivery?.[0]?.MonitoredStopVisit || [];
      } catch (e) {
        return null;
      }
    }

    function formatTime(isoString) {
      const dt = new Date(isoString);
      return dt.toLocaleTimeString("fr-FR", { hour: '2-digit', minute: '2-digit' });
    }

    function groupByDirection(visits) {
      const grouped = {};
      for (const v of visits) {
        const dir = v.MonitoredVehicleJourney?.DirectionName?.value || "Sens inconnu";
        const dest = v.MonitoredVehicleJourney?.DestinationName?.value || "Terminus ?";
        const line = v.MonitoredVehicleJourney?.PublishedLineName || "Ligne ?";
        const time = v.MonitoredVehicleJourney?.MonitoredCall?.ExpectedArrivalTime;
        if (!time) continue;
        const label = `${line} vers ${dest} ‚Üí ${formatTime(time)}`;
        if (!grouped[dir]) grouped[dir] = [];
        grouped[dir].push(label);
      }
      return grouped;
    }

    async function displayStop(id, ref) {
      const el = document.getElementById(id);
      const visits = await fetchPrim(ref);
      if (!visits || visits.length === 0) {
        el.innerHTML = "<span class='error'>Aucune donn√©e disponible</span>";
        return;
      }
      const grouped = groupByDirection(visits);
      let html = "";
      for (const dir in grouped) {
        html += `<strong>${dir}</strong><br>`;
        html += grouped[dir].map(x => `‚Ä¢ ${x}`).join("<br>") + "<br><br>";
      }
      el.innerHTML = html;
    }

    async function getVelibData() {
      try {
        const [statusRes, infoRes] = await Promise.all([
          fetch("https://velib-metropole-opendata.smovengo.cloud/opendata/Velib_Metropole/station_status.json"),
          fetch("https://velib-metropole-opendata.smovengo.cloud/opendata/Velib_Metropole/station_information.json")
        ]);
        const status = await statusRes.json();
        const info = await infoRes.json();

        const lines = velibStations.map(id => {
          const sInfo = info.data.stations.find(s => s.station_id == id);
          const sStat = status.data.stations.find(s => s.station_id == id);
          if (!sInfo || !sStat) return null;

          const name = sInfo.name;
          const ebike = sStat.num_bikes_available_types?.[0]?.ebike || 0;
          const mech = sStat.num_bikes_available_types?.[0]?.mechanical || 0;
          const docks = sStat.num_docks_available;

          return `<strong>${name}</strong> : üîå ${ebike} / üö≤ ${mech} ‚Äî ${docks} bornes libres`;
        }).filter(Boolean).join("<br>");

        document.getElementById("velib-data").innerHTML = lines || "Pas de donn√©es V√©lib'";
      } catch {
        document.getElementById("velib-data").innerHTML = "<span class='error'>Erreur de chargement V√©lib'</span>";
      }
    }

    function updateTimestamp() {
      const now = new Date();
      document.getElementById("last-update").innerText =
        "Derni√®re mise √† jour : " + now.toLocaleString("fr-FR");
    }

    async function refreshAll() {
      await Promise.all([
        displayStop("rer-data", stops.rer),
        displayStop("bus77-data", stops.bus77),
        displayStop("bus201-data", stops.bus201),
        getVelibData()
      ]);
      updateTimestamp();
    }

    refreshAll();
    setInterval(refreshAll, 60000);
  </script>
</body>
</html>
