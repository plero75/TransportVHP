<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tableau Transports - Vincennes</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 {
      margin: 0;
      font-size: 2rem;
    }
    .section {
      margin-top: 30px;
      width: 100%;
      max-width: 900px;
    }
    .line {
      border-bottom: 1px solid #444;
      padding: 10px 0;
    }
    .line h2 {
      margin: 0 0 10px;
    }
    .departure {
      margin-left: 20px;
    }
    .timestamp {
      font-size: 0.9rem;
      color: #aaa;
      margin-top: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>‚è± Transports en Temps R√©el ‚Äì Hippodrome de Vincennes</h1>
  <div class="section" id="weather"></div>
  <div class="section" id="bus"></div>
  <div class="section" id="rer"></div>
  <div class="section" id="velib"></div>
  <div class="timestamp" id="timestamp"></div>

  <script>
    const stops = [
      {{ name: "Hippodrome de Vincennes", ref: "STIF:StopPoint:Q:43972" }},
      {{ name: "√âcole du Breuil", ref: "STIF:StopPoint:Q:43974" }}
    ];
    const rerStops = [
      {{ name: "Joinville-le-Pont", ref: "STIF:StopPoint:Q:43851" }}
    ];
    const velibStations = [
      {{ name: "Hippodrome de Vincennes", station_id: "12029" }}
    ];

    async function fetchDepartures(ref) {
      const res = await fetch(`https://ratp-proxy.hippodrome-proxy42.workers.dev/?ref=${ref}`);
      if (!res.ok) return null;
      const data = await res.json();
      return data.Siri.ServiceDelivery.StopMonitoringDelivery[0].MonitoredStopVisit;
    }

    function groupDepartures(visits) {
      const grouped = {};
      visits.forEach(visit => {
        const dirRaw = visit.MonitoredVehicleJourney.DirectionName;
        const dir = dirRaw?.value || dirRaw || "Direction inconnue";
        const call = visit.MonitoredVehicleJourney.MonitoredCall;
        if (!call || (!call.ExpectedArrivalTime && !call.AimedArrivalTime)) return;
        const dt = new Date(call.ExpectedArrivalTime || call.AimedArrivalTime);
        const now = new Date();
        const diffMin = Math.floor((dt - now) / 60000);
        if (diffMin < 2) return;
        if (!grouped[dir]) grouped[dir] = [];
        grouped[dir].push({ time: dt, inMin: diffMin });
      });
      return grouped;
    }

    async function showBus() {
      const container = document.getElementById("bus");
      container.innerHTML = "";
      for (const stop of stops) {
        const visits = await fetchDepartures(stop.ref);
        if (!visits) continue;
        const grouped = groupDepartures(visits);
        const section = document.createElement("div");
        section.className = "line";
        section.innerHTML = `<h2>üöå ${stop.name}</h2>`;
        for (const dir in grouped) {
          section.innerHTML += `<div><strong>${dir}</strong></div>`;
          grouped[dir].forEach(dep => {
            const timeStr = dep.time.toLocaleTimeString("fr-FR", { hour: '2-digit', minute: '2-digit' });
            section.innerHTML += `<div class="departure">Dans ${dep.inMin} min (${timeStr})</div>`;
          });
        }
        container.appendChild(section);
      }
    }

    async function showRER() {
      const container = document.getElementById("rer");
      container.innerHTML = "";
      for (const stop of rerStops) {
        const visits = await fetchDepartures(stop.ref);
        if (!visits) continue;
        const grouped = groupDepartures(visits);
        const section = document.createElement("div");
        section.className = "line";
        section.innerHTML = `<h2>üöÜ RER A ‚Äì ${stop.name}</h2>`;
        for (const dir in grouped) {
          section.innerHTML += `<div><strong>${dir}</strong></div>`;
          grouped[dir].forEach(dep => {
            const timeStr = dep.time.toLocaleTimeString("fr-FR", { hour: '2-digit', minute: '2-digit' });
            section.innerHTML += `<div class="departure">Dans ${dep.inMin} min (${timeStr})</div>`;
          });
        }
        container.appendChild(section);
      }
    }

    async function showVelib() {
      const el = document.getElementById("velib");
      el.innerHTML = "<h2>üö≤ V√©lib'</h2>";
      const res = await fetch("https://velib-metropole-opendata.smoove.pro/opendata/Velib_Metropole/station_information.json");
      const status = await fetch("https://velib-metropole-opendata.smoove.pro/opendata/Velib_Metropole/station_status.json");
      if (!res.ok || !status.ok) return;
      const info = await res.json();
      const stat = await status.json();
      velibStations.forEach(({ station_id, name }) => {
        const target = info.data.stations.find(s => s.station_id === station_id);
        const avail = stat.data.stations.find(s => s.station_id === station_id);
        if (!target || !avail) return;
        el.innerHTML += `<div class="departure">${name} : ${avail.num_bikes_available} v√©los / ${avail.num_docks_available} bornes</div>`;
      });
    }

    async function showWeather() {
      const el = document.getElementById("weather");
      el.innerHTML = "";
      const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=48.8328&longitude=2.4359&current_weather=true");
      if (!res.ok) return;
      const data = await res.json();
      const temp = data.current_weather.temperature;
      const cond = data.current_weather.weathercode;
      const icon = cond < 3 ? "‚òÄÔ∏è" : cond < 60 ? "‚õÖ" : "üåßÔ∏è";
      el.innerHTML = `<h2>${icon} M√©t√©o √† Vincennes</h2>
        <div class="departure">${temp}¬∞C - ${getWeatherDesc(cond)}</div>`;
    }

    function getWeatherDesc(code) {
      if (code < 3) return "Ensoleill√©";
      if (code < 60) return "Partiellement nuageux";
      return "Pluvieux";
    }

    function updateTimestamp() {
      const now = new Date();
      const ts = document.getElementById("timestamp");
      ts.textContent = `Derni√®re mise √† jour : ${now.toLocaleDateString("fr-FR", { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} ‚Äì ${now.toLocaleTimeString("fr-FR")}`;
    }

    async function updateAll() {
      await showWeather();
      await showBus();
      await showRER();
      await showVelib();
      updateTimestamp();
    }

    updateAll();
    setInterval(updateAll, 60000);
  </script>
</body>
</html>
